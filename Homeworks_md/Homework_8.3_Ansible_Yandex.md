# devops-netology
### Желобанов Егор DEVOPS-21

# Домашнее задание к занятию "8.3. Использование Yandex Cloud"

## Подготовка к выполнению

1. Подготовьте в Yandex Cloud три хоста: для `clickhouse`, для `vector` и для `lighthouse`.

Ссылка на репозиторий LightHouse: https://github.com/VKCOM/lighthouse

## Основная часть

1. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает lighthouse.
2. При создании tasks рекомендую использовать модули: `get_url`, `template`, `yum`, `apt`.
3. Tasks должны: скачать статику lighthouse, установить nginx или любой другой webserver, настроить его конфиг для открытия lighthouse, запустить webserver.
4. Приготовьте свой собственный inventory файл `prod.yml`.
5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.
6. Попробуйте запустить playbook на этом окружении с флагом `--check`.
7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.
8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.
9. Подготовьте README.md файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.
10. Готовый playbook выложите в свой репозиторий, поставьте тег `08-ansible-03-yandex` на фиксирующий коммит, в ответ предоставьте ссылку на него.

### Ответ:
1. Для подготовки хостов в Yandex Cloud использовал terraform, [файл main.tf](/practice/08.3/terraform/main.tf).
2. Для создания tasks модифицировал файл из предыдущего задания. Решено добавить `template`.
3. Для работы сервиса lighthouse я выбрал использовать веб-сервер nginx, т.к. имею опыт работы с ним.
4. Дописал свой inventory файл [prod.yml](/practice/08.3/ansible/playbook/inventory/prod.yml).
5. При запуске `ansible-lint site.yml` ошибок нет, т.к. в процессе выполнения многократно правились файлы и к сожалению забыл заскринить ошибки.
6. Запуск playbook на рабочем окружении Yandex.Cloud с флагом `--diff`:
    ```shell
    egor@netology:~/Homeworks/08.3/ansible$ ansible-playbook -i inventory/prod.yml site.yml --diff
    
    PLAY [Install Clickhouse] ************************************************************************************************************************************************************
    
    TASK [Gathering Facts] ***************************************************************************************************************************************************************
    ok: [clickhouse-01]
    
    TASK [Get clickhouse distrib] ********************************************************************************************************************************************************
    ok: [clickhouse-01] => (item=clickhouse-client)
    ok: [clickhouse-01] => (item=clickhouse-server)
    ok: [clickhouse-01] => (item=clickhouse-common-static)
    
    TASK [Install clickhouse packages] ***************************************************************************************************************************************************
    fatal: [clickhouse-01]: FAILED! => {"changed": false, "msg": "Failed to validate GPG signature for clickhouse-common-static-23.1.1.3077-1.x86_64: Package clickhouse-common-static-23.1.1.3077.rpm is not signed"}
    
    PLAY RECAP ***************************************************************************************************************************************************************************
    clickhouse-01              : ok=2    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
    ```  
   Вышеуказанную ошибку устранил, добавив в файл `site.yml` в места установок из rpm пакетов строки:
   ```yaml
   - name: Install clickhouse packages
         become: true
         ansible.builtin.yum:
           disable_gpg_check: yes
   ```  
   И также добавил строку `disable_gpg_check: yes` в task где устанавливается vector.
7. Повторный и последующий запуск с флагом `--diff` проходит без ошибок:
    ```shell
    egor@netology:~/Homeworks/08.3/ansible$ ansible-playbook -i inventory/prod.yml site.yml --diff
    
    PLAY [Install Clickhouse] ************************************************************************************************************************************************************
    
    TASK [Gathering Facts] ***************************************************************************************************************************************************************
    ok: [clickhouse-01]
    
    TASK [Get clickhouse distrib] ********************************************************************************************************************************************************
    ok: [clickhouse-01] => (item=clickhouse-client)
    ok: [clickhouse-01] => (item=clickhouse-server)
    ok: [clickhouse-01] => (item=clickhouse-common-static)
    
    TASK [Install clickhouse packages] ***************************************************************************************************************************************************
    ok: [clickhouse-01]
    
    TASK [Create database] ***************************************************************************************************************************************************************
    ok: [clickhouse-01]
    
    PLAY [Install vector] ****************************************************************************************************************************************************************
    
    TASK [Gathering Facts] ***************************************************************************************************************************************************************
    ok: [vector-01]
    
    PLAY [Install vector] ****************************************************************************************************************************************************************
    
    TASK [Gathering Facts] ***************************************************************************************************************************************************************
    ok: [vector-01]
    
    TASK [vector | Install rpm] **********************************************************************************************************************************************************
    ok: [vector-01]
    
    TASK [vector | Template config] ******************************************************************************************************************************************************
    ok: [vector-01]
    
    TASK [vector | Create systemd unit] **************************************************************************************************************************************************
    ok: [vector-01]
    
    TASK [vector | Start service] ********************************************************************************************************************************************************
    ok: [vector-01]
    
    PLAY [Install Nginx] *****************************************************************************************************************************************************************
    
    TASK [Gathering Facts] ***************************************************************************************************************************************************************
    ok: [lighthouse-01]
    
    TASK [Install epel-release] **********************************************************************************************************************************************************
    ok: [lighthouse-01]
    
    TASK [Install Nginx] *****************************************************************************************************************************************************************
    ok: [lighthouse-01]
    
    TASK [Create dir for Lighthouse] *****************************************************************************************************************************************************
    ok: [lighthouse-01]
    
    TASK [Create Nginx config] ***********************************************************************************************************************************************************
    ok: [lighthouse-01]
    
    PLAY [Install lighthouse] ************************************************************************************************************************************************************
    
    TASK [Gathering Facts] ***************************************************************************************************************************************************************
    ok: [lighthouse-01]
    
    TASK [Install git] *******************************************************************************************************************************************************************
    ok: [lighthouse-01]
    
    TASK [Copy lighthouse from git] ******************************************************************************************************************************************************
    ok: [lighthouse-01]
    
    TASK [Create lighthouse config] ******************************************************************************************************************************************************
    ok: [lighthouse-01]
    
    TASK [Show connect URL lighthouse] ***************************************************************************************************************************************************
    ok: [lighthouse-01] => {
        "msg": "http://130.193.49.24/#http://51.250.10.112:8123/?user=netology"
    }
    
    PLAY RECAP ***************************************************************************************************************************************************************************
    clickhouse-01              : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    lighthouse-01              : ok=10   changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    vector-01                  : ok=6    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    ``` 
8. По playbook подготовил файл [READ.ME](https://github.com/E-zh/devops-netology-08/blob/main/08.3/README.md).
9. Ссылку на [репозиторий](https://github.com/E-zh/devops-netology-08) прилагаю.