# devops-netology

### Желобанов Егор DEVOPS-21

# Домашнее задание к занятию 13.4 «Обновление приложений»

### Цель задания

Выбрать и настроить стратегию обновления приложения.

### Чеклист готовности к домашнему заданию

1. Кластер K8s.

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Документация Updating a Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment).
2. [Статья про стратегии обновлений](https://habr.com/ru/companies/flant/articles/471620/).

-----

### Задание 1. Выбрать стратегию обновления приложения и описать ваш выбор

1. Имеется приложение, состоящее из нескольких реплик, которое требуется обновить.
2. Ресурсы, выделенные для приложения, ограничены, и нет возможности их увеличить.
3. Запас по ресурсам в менее загруженный момент времени составляет 20%.
4. Обновление мажорное, новые версии приложения не умеют работать со старыми.
5. Вам нужно объяснить свой выбор стратегии обновления приложения.

### Ответ:
1. Здесь, при наличии факторов ограниченных ресурсов и без возможности их увеличения, а также мажорном обновлении, когда новые версии приложения не умеют работать со старыми, я вижу вариант обновления Recreate - старые pod'ы убиваются все разом и заменяются новыми:  
    ![](/pics/13.4/recreate_schema.jpg)
---

### Задание 2. Обновить приложение

1. Создать deployment приложения с контейнерами nginx и multitool. Версию nginx взять 1.19. Количество реплик — 5.
2. Обновить версию nginx в приложении до версии 1.20, сократив время обновления до минимума. Приложение должно быть доступно.
3. Попытаться обновить nginx до версии 1.28, приложение должно оставаться доступным.
4. Откатиться после неудачного обновления.

### Ответ:
1. Создал [deployment](/practice/13.4/deployment.yaml) приложения с контейнерами nginx и multitool. Версия nginx - 1.19. Количество реплик — 5:  
    ![](/pics/13.4/run_deployment.jpg)  
2. Обновляем версию nginx в приложении до версии 1.20, выполняем `kubectl apply -f deployment.yaml`:  
    ![](/pics/13.4/deployment_updated.jpg)  
    Приложение обновлено, запускаем еще раз `kubectl get pods -w` и видим что все работает:  
    ![](/pics/13.4/deployment_updated2.jpg)  
3. Обновляем версию nginx в приложении до версии 1.28, выполняем `kubectl apply -f deployment.yaml`, видим что поды не могут обновиться, приложение по прежнему работает с версией `nginx 1.20`:    
    ![](/pics/13.4/deployment_error_update.jpg)
4. Откатываемся до последнего удачного обновления командой `kubectl rollout undo deployment task1 --to-revision=2`:  
    ![](/pics/13.4/deployment_rollout.jpg)  
    Запускаем еще раз `kubectl get pods -w` и видим что все работает, откат прошел успешно:  
    ![](/pics/13.4/deployment_rollout2.jpg)  
5. На этом задание выполнено.
